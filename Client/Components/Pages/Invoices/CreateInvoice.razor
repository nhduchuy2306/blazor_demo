@page "/invoice/create"
@rendermode InteractiveServer

@inject HttpClient HttpClient
@inject NavigationManager NavigationManager


<h3>Create Sales Invoice</h3>

@if (customers is null || products is null)
{
    <p>Unable to get data.</p>
}
else
{
    <EditForm Model="invoice" OnValidSubmit="SubmitInvoice">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label for="customer">Select Customer</label>
            <InputSelect id="customer" class="form-control" @bind-Value="invoice.CustomerId">
                <option value="">--- Select Customer ---</option>
                @foreach (var customer in customers)
                {
                    <option value="@customer.CustomerId">@customer.CustomerName</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => invoice.CustomerId)" />

            <h4>Select Products</h4>
            <div class="form-group">
                <label for="product">Select Product</label>
                <InputSelect id="product" class="form-control" @bind-Value="selectedProductId">
                    <option value="">--- Select Product ---</option>
                    @foreach (var product in products)
                    {
                        <option value="@product.ProductId">@product.ProductName</option>
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="quantity">Quantity</label>
                <InputNumber id="quantity" class="form-control" @bind-Value="quantity" />
            </div>

            <button class="btn btn-info" style="margin:0 10px" @onclick="AddProduct">Add Product</button>

            <h4>Selected Products</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detail in selectedProducts)
                    {
                        <tr>
                            <td>@detail.ProductName</td>
                            <td>@detail.Quantity</td>
                            <td>@detail.UnitPrice</td>
                            <td>@(detail.Quantity * detail.UnitPrice)</td>
                            <td><button class="btn btn-danger" @onclick="() => RemoveProduct(detail)">Remove</button></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="form-group">
            <label>Total Amount</label>
            <p>@invoice.TotalAmount</p>
        </div>

        <button type="submit" class="btn btn-primary" disabled="@(!selectedProducts.Any())">Create Invoice</button>
    </EditForm>
}
@code {
    private SalesInvoiceInputUiModel invoice = new SalesInvoiceInputUiModel();
    private IEnumerable<CustomerUiModel>? customers;
    private IEnumerable<ProductUiModel>? products;
    private int selectedProductId;
    private int quantity = 1;
    private List<InvoiceDetailUiModel> selectedProducts = new List<InvoiceDetailUiModel>();

    protected override async Task OnInitializedAsync()
    {
        var customerRequest = await HttpClient.GetAsync("api/customers");
        var productRequest = await HttpClient.GetAsync("api/products");

        if (customerRequest.IsSuccessStatusCode)
        {
            customers = await customerRequest.Content.ReadFromJsonAsync<IEnumerable<CustomerUiModel>>();
        }

        if (productRequest.IsSuccessStatusCode)
        {
            products = await productRequest.Content.ReadFromJsonAsync<IEnumerable<ProductUiModel>>();
        }
    }

    private void AddProduct()
    {
        if (selectedProductId == 0 || quantity <= 0) return;

        var product = products?.FirstOrDefault(p => p.ProductId == selectedProductId);
        if (product != null)
        {
            var existingDetail = selectedProducts.FirstOrDefault(d => d.ProductId == product.ProductId);
            if (existingDetail != null)
            {
                existingDetail.Quantity += quantity;
                existingDetail.Total = existingDetail.Quantity * existingDetail.UnitPrice;
            }
            else
            {
                selectedProducts.Add(new InvoiceDetailUiModel
                    {
                        ProductId = product.ProductId,
                        ProductName = product.ProductName,
                        Quantity = quantity,
                        UnitPrice = product.UnitPrice,
                        Total = quantity * product.UnitPrice
                    });
            }
        }

        invoice.TotalAmount = selectedProducts.Sum(d => d.Quantity * d.UnitPrice);

        selectedProductId = 0;
        quantity = 1;
    }

    private void RemoveProduct(InvoiceDetailUiModel detail)
    {
        selectedProducts.Remove(detail);
        invoice.TotalAmount = selectedProducts.Sum(d => d.Quantity * d.UnitPrice);
    }

    private async Task SubmitInvoice()
    {
        invoice.InvoiceDetails = selectedProducts ?? new List<InvoiceDetailUiModel>();
        invoice.TotalAmount = invoice.InvoiceDetails.Sum(d => d.Quantity * d.UnitPrice);
        var response = await HttpClient.PostAsJsonAsync("api/invoices", invoice);

        if (response.IsSuccessStatusCode)
        {
            NavigationManager.NavigateTo("/invoice");
        }
    }
}

